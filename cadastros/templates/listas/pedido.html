{% extends "paginasweb/modelo.html" %}
{% load static %}

{% block conteudo %}
<section class="py-5 mt-5">
    <div class="container px-4 px-lg-5">
        <div class="mb-5">
            <!-- Cabeçalho -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <h1 class="text-dark fw-light mb-2">
                            {% if request.user.is_authenticated %}
                                Meus Pedidos
                            {% else %}
                                Pedidos
                            {% endif %}
                        </h1>
                        <div class="border-bottom border-2 border-primary" style="width: 80px;"></div>
                    </div>
                    {% if request.user.is_authenticated %}
                        <a class="btn-add-round" href="{% url 'cadastrar-pedido' %}" title="Cadastrar Novo Pedido">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                </div>
                {% if request.user.is_authenticated %}
                    <div class="text-end">
                        <small class="text-muted d-block">
                            <i class="fas fa-user me-1"></i>Logado como: {{ user.first_name|default:user.username }}
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-boxes me-1"></i>Total: {{ pedidos|length }} pedido{{ pedidos|length|pluralize }}
                        </small>
                    </div>
                {% endif %}
            </div>

            <!-- Tabela de Pedidos -->
            {% if pedidos %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th width="8%">
                                    <i class="fas fa-hashtag me-1"></i>ID
                                </th>
                                <th width="25%">
                                    <i class="fas fa-truck me-1"></i>Fornecedor
                                </th>
                                <th width="15%">
                                    <i class="fas fa-calendar me-1"></i>Data Pedido
                                </th>
                                <th width="12%">
                                    <i class="fas fa-clock me-1"></i>Previsão
                                </th>
                                <th width="10%">
                                    <i class="fas fa-info-circle me-1"></i>Status
                                </th>
                                <th width="12%">
                                    <i class="fas fa-dollar-sign me-1"></i>Valor Total
                                </th>
                                <th width="10%">
                                    <i class="fas fa-boxes me-1"></i>Itens
                                </th>
                                <th width="8%" class="text-center">
                                    <i class="fas fa-cog me-1"></i>Ações
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pedido in pedidos %}
                                <!-- Linha principal do pedido -->
                                <tr class="pedido-row" data-pedido-id="{{ pedido.id }}">
                                    <td class="fw-bold text-primary">
                                        #{{ pedido.id }}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-building text-muted me-2"></i>
                                            <div>
                                                <strong>{{ pedido.fornecedor.nome }}</strong>
                                                {% if pedido.fornecedor.cidade %}
                                                    <br><small class="text-muted">{{ pedido.fornecedor.cidade }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ pedido.data_pedido|date:"d/m/Y" }}
                                        <br><small class="text-muted">{{ pedido.data_pedido|date:"H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if pedido.previsao_entrega %}
                                            {{ pedido.previsao_entrega|date:"d/m/Y" }}
                                        {% else %}
                                            <span class="text-muted">Não definida</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if pedido.status == 'pendente' %}
                                            <span class="badge bg-warning text-dark">Pendente</span>
                                        {% elif pedido.status == 'em_andamento' %}
                                            <span class="badge bg-info">Em Andamento</span>
                                        {% else %}
                                            <span class="badge bg-success">Finalizado</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold text-success">
                                        R$ {{ pedido.valor_total|floatformat:2 }}
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm toggle-itens" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#itens-{{ pedido.id }}" 
                                                aria-expanded="false"
                                                title="Ver Itens ({{ pedido.itempedido_set.count }})">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'pedido-update' pedido.pk %}" 
                                               class="btn btn-outline-warning btn-sm" 
                                               title="Editar Pedido">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'pedido-deletar' pedido.pk %}" 
                                               class="btn btn-outline-danger btn-sm" 
                                               title="Excluir Pedido">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Linha expansível com itens do pedido -->
                                <tr class="collapse" id="itens-{{ pedido.id }}">
                                    <td colspan="8" class="p-0">
                                        <div class="bg-light p-3">
                                            {% if pedido.itempedido_set.all %}
                                                <h6 class="mb-3 text-muted">
                                                    <i class="fas fa-box me-2"></i>
                                                    Itens do Pedido #{{ pedido.id }}
                                                </h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-borderless mb-0">
                                                        <thead class="table-secondary">
                                                            <tr>
                                                                <th width="35%">Item</th>
                                                                <th width="15%" class="text-center">Quantidade</th>
                                                                <th width="15%" class="text-center">Valor Unit.</th>
                                                                <th width="15%" class="text-center">Total</th>
                                                                <th width="20%">Frota</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for item_pedido in pedido.itempedido_set.all %}
                                                                <tr>
                                                                    <td>
                                                                        <div class="d-flex align-items-center">
                                                                            <i class="fas fa-cube text-muted me-2"></i>
                                                                            <div>
                                                                                <strong>{{ item_pedido.item.nome }}</strong>
                                                                                <br>
                                                                                <small class="text-muted">
                                                                                    <i class="fas fa-tag me-1"></i>
                                                                                    {{ item_pedido.item.categoria.nome }}
                                                                                </small>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="badge bg-secondary">
                                                                            {{ item_pedido.quantidade }}
                                                                        </span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="text-success">
                                                                            R$ {{ item_pedido.valor_unitario|floatformat:2 }}
                                                                        </span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <span class="fw-bold text-primary">
                                                                            R$ {% widthratio item_pedido.quantidade 1 item_pedido.valor_unitario as total %}{{ total|floatformat:2 }}
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        {% if item_pedido.frota %}
                                                                            <div class="d-flex align-items-center">
                                                                                <i class="fas fa-truck text-warning me-2"></i>
                                                                                <div>
                                                                                    <strong>{{ item_pedido.frota.prefixo }}</strong>
                                                                                    <br>
                                                                                    <small class="text-muted">
                                                                                        {{ item_pedido.frota.descricao|truncatechars:20 }}
                                                                                    </small>
                                                                                </div>
                                                                            </div>
                                                                        {% else %}
                                                                            <span class="text-muted">
                                                                                <i class="fas fa-minus me-1"></i>
                                                                                Sem frota
                                                                            </span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% else %}
                                                <div class="text-center py-3">
                                                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                                    <p class="text-muted mb-0">Este pedido não possui itens cadastrados</p>
                                                </div>
                                            {% endif %}
                                            
                                            {% if pedido.descricao %}
                                                <div class="mt-3 p-2 bg-white rounded">
                                                    <small class="text-muted">
                                                        <i class="fas fa-comment me-1"></i>
                                                        <strong>Observações:</strong> {{ pedido.descricao }}
                                                    </small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <!-- Estado Vazio -->
                <div class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-file-invoice fa-4x text-muted mb-4"></i>
                        <h3 class="text-muted mb-3">Nenhum pedido encontrado</h3>
                        <p class="text-muted mb-4">
                            {% if request.user.is_authenticated %}
                                Você ainda não criou nenhum pedido. Comece criando seu primeiro pedido!
                            {% else %}
                                Faça login para ver seus pedidos.
                            {% endif %}
                        </p>
                        {% if request.user.is_authenticated %}
                            <a href="{% url 'cadastrar-pedido' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Criar Primeiro Pedido
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<style>
.pedido-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.pedido-row:hover {
    background-color: #f8f9fa !important;
}

.empty-state {
    max-width: 400px;
    margin: 0 auto;
}

.toggle-itens {
    transition: all 0.2s ease;
}

.toggle-itens:hover {
    transform: scale(1.05);
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.btn-group .btn {
    border-radius: 4px !important;
}

.btn-group .btn:first-child {
    margin-right: 2px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar funcionalidade de toggle para os botões de itens
    document.querySelectorAll('.toggle-itens').forEach(function(button) {
        button.addEventListener('click', function() {
            const icon = this.querySelector('i');
            const target = document.querySelector(this.getAttribute('data-bs-target'));
            
            // Alterar ícone baseado no estado
            target.addEventListener('show.bs.collapse', function() {
                icon.className = 'fas fa-list-ul me-1';
                button.innerHTML = '<i class="fas fa-list-ul me-1"></i>Ocultar Itens';
            });
            
            target.addEventListener('hide.bs.collapse', function() {
                icon.className = 'fas fa-list me-1';
                const count = button.textContent.match(/\((\d+)\)/)[1];
                button.innerHTML = `<i class="fas fa-list me-1"></i>Ver Itens (${count})`;
            });
        });
    });
});
</script>
{% endblock %}