{% extends "paginasweb/modelo.html" %}
{% load static %}

{% block conteudo %}
<section class="py-5 mt-5">
    <div class="container px-4 px-lg-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Cabeçalho -->
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <div>
                        <h1 class="text-dark fw-light mb-2">{{ titulo }}</h1>
                        <div class="border-bottom border-2 border-primary" style="width: 80px;"></div>
                    </div>
                    <a href="{% url 'pedido-list' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </a>
                </div>

                <!-- Formulário -->
                <form method="post" id="pedido-form">
                    {% csrf_token %}
                    
                    <!-- Card de Informações do Pedido -->
                    <div class="card mb-4 shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-file-invoice me-2"></i>
                                Informações do Pedido
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ pedido_form.fornecedor.id_for_label }}" class="form-label">
                                        {{ pedido_form.fornecedor.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ pedido_form.fornecedor }}
                                    {% if pedido_form.fornecedor.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ pedido_form.fornecedor.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ pedido_form.previsao_entrega.id_for_label }}" class="form-label">
                                        {{ pedido_form.previsao_entrega.label }}
                                    </label>
                                    {{ pedido_form.previsao_entrega }}
                                    {% if pedido_form.previsao_entrega.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ pedido_form.previsao_entrega.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if pedido_form.status %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ pedido_form.status.id_for_label }}" class="form-label">
                                        {{ pedido_form.status.label }}
                                    </label>
                                    {{ pedido_form.status }}
                                    {% if pedido_form.status.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ pedido_form.status.errors|join:", " }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="{{ pedido_form.descricao.id_for_label }}" class="form-label">
                                    {{ pedido_form.descricao.label }}
                                </label>
                                {{ pedido_form.descricao }}
                                {% if pedido_form.descricao.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ pedido_form.descricao.errors|join:", " }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Card de Itens do Pedido -->
                    <div class="card mb-4 shadow">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-boxes me-2"></i>
                                Itens do Pedido
                            </h5>
                            <button type="button" class="btn btn-light btn-sm" id="add-item-btn">
                                <i class="fas fa-plus me-1"></i>
                                Adicionar Item
                            </button>
                        </div>
                        <div class="card-body p-0">
                            {{ item_formset.management_form }}
                            
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="itens-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="25%">Item <span class="text-danger">*</span></th>
                                            <th width="15%" class="text-center">Quantidade <span class="text-danger">*</span></th>
                                            <th width="20%" class="text-center">Valor Unitário <span class="text-danger">*</span></th>
                                            <th width="15%" class="text-center">Total</th>
                                            <th width="20%">Frota</th>
                                            <th width="5%" class="text-center">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itens-tbody">
                                        {% for form in item_formset %}
                                            <tr class="item-form-row">
                                                <td>
                                                    {{ form.id }}
                                                    {{ form.item }}
                                                    {% if form.item.errors %}
                                                        <div class="text-danger small mt-1">
                                                            {{ form.item.errors|join:", " }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ form.quantidade }}
                                                    {% if form.quantidade.errors %}
                                                        <div class="text-danger small mt-1">
                                                            {{ form.quantidade.errors|join:", " }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R$</span>
                                                        {{ form.valor_unitario }}
                                                    </div>
                                                    {% if form.valor_unitario.errors %}
                                                        <div class="text-danger small mt-1">
                                                            {{ form.valor_unitario.errors|join:", " }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <span class="fw-bold text-success total-item">R$ 0,00</span>
                                                </td>
                                                <td>
                                                    {{ form.frota }}
                                                    {% if form.frota.errors %}
                                                        <div class="text-danger small mt-1">
                                                            {{ form.frota.errors|join:", " }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn" title="Remover Item">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        {% empty %}
                                            <tr id="no-items-row">
                                                <td colspan="6" class="text-center py-4 text-muted">
                                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                                    <p class="mb-2">Nenhum item adicionado ainda</p>
                                                    <small>Clique em "Adicionar Item" para começar</small>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th colspan="3" class="text-end">Total Geral:</th>
                                            <th class="text-center">
                                                <span class="fw-bold text-primary fs-5" id="total-geral">R$ 0,00</span>
                                            </th>
                                            <th colspan="2"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Template para novos itens (oculto) -->
                            <template id="empty-form-template">
                                <tr class="item-form-row">
                                    <td>
                                        <input type="hidden" name="itens-__prefix__-id" value="">
                                        <select name="itens-__prefix__-item" class="form-select item-select">
                                            <option value="">Selecione um item</option>
                                            {% for item in item_formset.0.item.field.queryset %}
                                                <option value="{{ item.id }}">{{ item.nome }} - {{ item.categoria.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="itens-__prefix__-quantidade" class="form-control" min="1" value="1">
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" name="itens-__prefix__-valor_unitario" class="form-control" step="0.01" min="0.01">
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="fw-bold text-success total-item">R$ 0,00</span>
                                    </td>
                                    <td>
                                        <select name="itens-__prefix__-frota" class="form-select">
                                            <option value="">Selecione uma frota (opcional)</option>
                                            {% for frota in item_formset.0.frota.field.queryset %}
                                                <option value="{{ frota.id }}">{{ frota.prefixo }} - {{ frota.descricao }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-item-btn" title="Remover Item">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'pedido-list' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            {% if pedido %}
                                <i class="fas fa-save me-2"></i>Atualizar Pedido
                            {% else %}
                                <i class="fas fa-save me-2"></i>Criar Pedido
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let formIndex = {{ item_formset.total_form_count|default:0 }};
    const addButton = document.getElementById('add-item-btn');
    const tbody = document.getElementById('itens-tbody');
    const totalFormInput = document.querySelector('#id_itens-TOTAL_FORMS');
    const form = document.getElementById('pedido-form');
    const submitBtn = document.getElementById('submit-btn');
    const noItemsRow = document.getElementById('no-items-row');

    // Debug: Verificar se elementos existem
    console.log('Form found:', form);
    console.log('Total forms input:', totalFormInput);
    console.log('Initial form index:', formIndex);

    // Função para mostrar/ocultar linha "sem itens"
    function toggleNoItemsRow() {
        const itemRows = document.querySelectorAll('.item-form-row:not([data-deleted="true"])');
        if (noItemsRow) {
            if (itemRows.length === 0) {
                noItemsRow.style.display = '';
            } else {
                noItemsRow.style.display = 'none';
            }
        }
    }

    // Interceptar submit para debug
    form.addEventListener('submit', function(e) {
        console.log('Form submit intercepted');
        
        // Verificar se há pelo menos um item
        const itemForms = document.querySelectorAll('.item-form-row:not([data-deleted="true"])');
        console.log('Active item forms:', itemForms.length);
        
        if (itemForms.length === 0) {
            e.preventDefault();
            alert('Adicione pelo menos um item ao pedido!');
            return false;
        }
        
        // Validar campos obrigatórios dos itens
        let hasError = false;
        let errorMessage = '';
        
        itemForms.forEach(function(row, index) {
            const item = row.querySelector('select[name*="item"]');
            const quantidade = row.querySelector('input[name*="quantidade"]');
            const valor = row.querySelector('input[name*="valor_unitario"]');
            
            if (!item.value) {
                hasError = true;
                errorMessage += `Item ${index + 1}: Selecione um item\n`;
            }
            if (!quantidade.value || quantidade.value <= 0) {
                hasError = true;
                errorMessage += `Item ${index + 1}: Informe a quantidade\n`;
            }
            if (!valor.value || valor.value <= 0) {
                hasError = true;
                errorMessage += `Item ${index + 1}: Informe o valor unitário\n`;
            }
        });
        
        if (hasError) {
            e.preventDefault();
            alert('Corrija os seguintes erros:\n\n' + errorMessage);
            return false;
        }
        
        console.log('Form validation passed, submitting...');
        
        // Log do FormData para debug
        const formData = new FormData(form);
        console.log('FormData entries:');
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }
        
        // Deixar o submit continuar normalmente
    });

    // Função para calcular totais
    function calculateTotals() {
        let totalGeral = 0;

        document.querySelectorAll('.item-form-row:not([data-deleted="true"])').forEach(function(row) {
            const quantidade = row.querySelector('input[name*="quantidade"]');
            const valorUnitario = row.querySelector('input[name*="valor_unitario"]');
            const totalItem = row.querySelector('.total-item');

            if (quantidade && valorUnitario && quantidade.value && valorUnitario.value) {
                // Usa getCurrencyValue() para obter valor numérico da máscara de moeda
                const qtd = parseFloat(quantidade.value) || 0;
                const valor = window.getCurrencyValue ? window.getCurrencyValue(valorUnitario) : parseFloat(valorUnitario.value.replace(',', '.')) || 0;
                const total = qtd * valor;

                totalItem.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                totalGeral += total;
            } else {
                totalItem.textContent = 'R$ 0,00';
            }
        });

        document.getElementById('total-geral').textContent = `R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
    }

    // Função para adicionar novo item
    function addNewItem() {
        const template = document.getElementById('empty-form-template');
        const clone = template.content.cloneNode(true);
        
        // Substituir __prefix__ pelos índices corretos
        const row = clone.querySelector('tr');
        row.innerHTML = row.innerHTML.replace(/__prefix__/g, formIndex);
        
        tbody.appendChild(row);
        
        formIndex++;
        totalFormInput.value = formIndex;
        
        // Adicionar event listeners para os novos campos
        addEventListeners(tbody.lastElementChild);
        
        // Adicionar required aos campos necessários
        const newRow = tbody.lastElementChild;
        newRow.querySelector('select[name*="item"]').required = true;
        newRow.querySelector('input[name*="quantidade"]').required = true;
        newRow.querySelector('input[name*="valor_unitario"]').required = true;

        // Aplicar máscara de moeda no campo valor_unitario do novo item
        const valorField = newRow.querySelector('input[name*="valor_unitario"]');
        if (valorField && window.IMask) {
            valorField.type = 'text'; // Mudar de number para text
            IMask(valorField, {
                mask: 'R$ num',
                blocks: {
                    num: {
                        mask: Number,
                        thousandsSeparator: '.',
                        radix: ',',
                        scale: 2,
                        min: 0,
                        max: 999999999.99,
                        padFractionalZeros: true,
                        normalizeZeros: true,
                        mapToRadix: ['.']
                    }
                }
            });
            valorField.classList.add('masked-currency');
        }

        // Ocultar linha "sem itens"
        toggleNoItemsRow();
    }

    // Função para remover item
    function removeItem(button) {
        const row = button.closest('tr');
        
        // Sempre remover completamente a linha
        row.remove();
        
        // Reajustar o número total de formulários
        formIndex--;
        totalFormInput.value = formIndex;
        
        calculateTotals();
        toggleNoItemsRow();
    }

    // Função para adicionar event listeners
    function addEventListeners(row) {
        const quantidade = row.querySelector('input[name*="quantidade"]');
        const valorUnitario = row.querySelector('input[name*="valor_unitario"]');
        const removeBtn = row.querySelector('.remove-item-btn');
        
        if (quantidade) {
            quantidade.addEventListener('input', calculateTotals);
        }
        if (valorUnitario) {
            valorUnitario.addEventListener('input', calculateTotals);
        }
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                removeItem(this);
            });
        }
    }

    // Adicionar event listeners para linhas existentes
    document.querySelectorAll('.item-form-row').forEach(function(row) {
        addEventListeners(row);
    });

    // Event listener para botão de adicionar
    addButton.addEventListener('click', addNewItem);

    // Calcular totais iniciais
    calculateTotals();
    
    // Verificar se deve mostrar linha "sem itens"
    toggleNoItemsRow();
});
</script>

<style>
.item-form-row input, .item-form-row select {
    border-radius: 4px;
}

.item-form-row:hover {
    background-color: #f8f9fa;
}

.total-item {
    font-size: 0.9em;
}

#total-geral {
    font-size: 1.2em !important;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
}

.input-group-text {
    font-size: 0.875rem;
}
</style>
{% endblock %}